# go-xrouter

![Building](https://img.shields.io/badge/building-passing-green.svg)
![License](https://img.shields.io/badge/license-MIT-blue.svg)

**go-xrouter** is a trie based HTTP request router. Its implementation is based on [httprouter]()    
package, but you can delete an existing handler without creating a new route, or add a new    
handler in runtime. I think it's useful in some scenarios which you want to modify route dynamically.     

## Implementation

The main structure ([*Radix Tree*][Radix Tree]) of **go-xrouter** is same as **httprouter**, so if you  
want to know how it works, you can see the [Wiki][how_work] of **httprouter**. I just list some    
main differences between **go-xrouter** and **httprouter**:


- The configure options of *xrouter* are not exported, you only can set it when you create a   
`XRouter`. Because a `XRouter` is used by multiple goroutines, change the configure options     
directly is not concurrent safe (We shouldn't assume that **load/store** a bool or a function field   
is atomicity), so I hide them.
- Search a handler for a request, add a new handler or remove an existing handler, these three     
operations are restricted by [RWMutex](https://golang.org/pkg/sync/#RWMutex).
- If add a new handler failed, it will return a error describing the reason rather than leading the   
program panic.     
- Add `Remove` function to remove an existing handler.   


## Usage

```go

package main

import (
	"fmt"
	"github.com/X-Plan/xgo/go-xrouter"
	"log"
	"net/http"
)

var xr *xrouter.XRouter

func Index(w http.ResponseWriter, r *http.Request, _ xrouter.XParams) {
	fmt.Fprint(w, "Welcome!\n")
}

func Hello(w http.ResponseWriter, r *http.Request, xps xrouter.XParams) {
	fmt.Fprintf(w, "Hello, %s!\n", xps.Get("name"))
}

func Add(w http.ResponseWriter, r *http.Request, xps xrouter.XParams) {
	method, path := xps.Get("method"), "/"+xps.Get("path")
	err := xr.Handle(method, path, func(w http.ResponseWriter, r *http.Request, xps xrouter.XParams) {
		fmt.Fprintf(w, "path: %s, xps: %s\n", path, xps)
	})
	if err != nil {
		w.WriteHeader(400)
		fmt.Fprintf(w, "[ERROR]: %s\n", err)
	} else {
		fmt.Fprintf(w, "OK\n")
	}
	return
}

func Remove(w http.ResponseWriter, r *http.Request, xps xrouter.XParams) {
	method, path := xps.Get("method"), "/"+xps.Get("path")
	err := xr.Remove(method, path)
	if err != nil {
		w.WriteHeader(400)
		fmt.Fprintf(w, "[ERROR]: %s\n", err)
	} else {
		fmt.Fprintf(w, "OK\n")
	}
}

func main() {
	xr = xrouter.New(&xrouter.XConfig{
		RedirectTrailingSlash:  true,
		RedirectFixedPath:      true,
		HandleOptions:          true,
		HandleMethodNotAllowed: true,
	})

	xr.GET("/", Index)
	xr.GET("/hello/:name", Hello)
	xr.GET("/add/:method/*path", Add)
	xr.GET("/remove/:method/*path", Remove)

	log.Fatal(http.ListenAndServe(":8080", xr))
}
```

This demo supports add and remove a handler dynamically, as follows.

```bash
$ curl "http://127.0.0.1:8080/"
Welcome!

$ curl "http://127.0.0.1:8080/hello/blinklv"
Hello, blinklv!

$ curl "http://127.0.0.1:8080/add/GET/hello/:name"
[ERROR]: path '/hello/:name' has already been registered

$ curl "http://127.0.0.1:8080/add/POST/foo/:bar"
OK
$ curl -X POST "http://127.0.0.1:8080/foo/blinklv"
path: /foo/:bar, xps: bar=blinklv

$ curl "http://127.0.0.1:8080/remove/POST/foo/:bar"
OK
$ curl -X POST "http://127.0.0.1:8080/foo/blinklv"
404 page not found
```

## Performance

Because **go-xrouter** is based on **httprouter**, so I just compare its performance with     
**httprouter**'s. The benchmark results are generated by [go-http-routing-benchmark][benchmark],    
it shows **go-xrouter** is a little slower than **httprouter**.

### Benchmark Machine    

- **MacBook Air**
- **Processor** 1.6 GHz Intel Core i5
- **Memory** 8 GB 1600 MHz DDR3

### Benchmark Results

```bash
#GithubAPI Routes: 203
  HttpRouter: 37464 Bytes
  XRouter: 28728 Bytes

#GPlusAPI Routes: 13
  HttpRouter: 2712 Bytes
  XRouter: 2856 Bytes

#ParseAPI Routes: 26
  HttpRouter: 4976 Bytes
  XRouter: 4448 Bytes

#Static Routes: 157
  HttpRouter: 21128 Bytes
  XRouter: 17480 Bytes

BenchmarkHttpRouter_Param        20000000       105 ns/op      32 B/op       1 allocs/op
BenchmarkXRouter_Param           10000000       159 ns/op      32 B/op       1 allocs/op
BenchmarkHttpRouter_Param5        5000000       275 ns/op     160 B/op       1 allocs/op
BenchmarkXRouter_Param5           5000000       298 ns/op     160 B/op       1 allocs/op
BenchmarkHttpRouter_Param20       2000000       764 ns/op     640 B/op       1 allocs/op
BenchmarkXRouter_Param20          2000000       786 ns/op     640 B/op       1 allocs/op
BenchmarkHttpRouter_ParamWrite   10000000       165 ns/op      32 B/op       1 allocs/op
BenchmarkXRouter_ParamWrite      10000000       224 ns/op      32 B/op       1 allocs/op
BenchmarkHttpRouter_GithubStatic 20000000      68.3 ns/op       0 B/op       0 allocs/op
BenchmarkXRouter_GithubStatic    20000000      97.6 ns/op       0 B/op       0 allocs/op
BenchmarkHttpRouter_GithubParam   5000000       271 ns/op      96 B/op       1 allocs/op
BenchmarkXRouter_GithubParam      5000000       311 ns/op      96 B/op       1 allocs/op
BenchmarkHttpRouter_GithubAll       30000     49559 ns/op   13792 B/op     167 allocs/op
BenchmarkXRouter_GithubAll          20000     59862 ns/op   13280 B/op     177 allocs/op
BenchmarkHttpRouter_GPlusStatic  30000000      43.1 ns/op       0 B/op       0 allocs/op
BenchmarkXRouter_GPlusStatic     20000000      74.4 ns/op       0 B/op       0 allocs/op
BenchmarkHttpRouter_GPlusParam   10000000       183 ns/op      64 B/op       1 allocs/op
BenchmarkXRouter_GPlusParam      10000000       185 ns/op      32 B/op       1 allocs/op
BenchmarkHttpRouter_GPlus2Params 10000000       212 ns/op      64 B/op       1 allocs/op
BenchmarkXRouter_GPlus2Params     5000000       367 ns/op      96 B/op       2 allocs/op
BenchmarkHttpRouter_GPlusAll      1000000      2174 ns/op     640 B/op      11 allocs/op
BenchmarkXRouter_GPlusAll          500000      3130 ns/op     640 B/op      15 allocs/op
BenchmarkHttpRouter_ParseStatic  30000000      42.0 ns/op       0 B/op       0 allocs/op
BenchmarkXRouter_ParseStatic     20000000      74.8 ns/op       0 B/op       0 allocs/op
BenchmarkHttpRouter_ParseParam   10000000       160 ns/op      64 B/op       1 allocs/op
BenchmarkXRouter_ParseParam      10000000       165 ns/op      32 B/op       1 allocs/op
BenchmarkHttpRouter_Parse2Params 10000000       182 ns/op      64 B/op       1 allocs/op
BenchmarkXRouter_Parse2Params     5000000       325 ns/op      96 B/op       2 allocs/op
BenchmarkHttpRouter_ParseAll       500000      2834 ns/op     640 B/op      16 allocs/op
BenchmarkXRouter_ParseAll          300000      4542 ns/op     640 B/op      17 allocs/op
BenchmarkHttpRouter_StaticAll      100000     14630 ns/op       0 B/op       0 allocs/op
BenchmarkXRouter_StaticAll         100000     21344 ns/op       0 B/op       0 allocs/op
```

[httprouter]: https://github.com/julienschmidt/httprouter
[how_work]: https://github.com/julienschmidt/httprouter#how-does-it-work
[Radix Tree]: https://en.wikipedia.org/wiki/Radix_tree
[benchmark]: https://github.com/julienschmidt/go-http-routing-benchmark

